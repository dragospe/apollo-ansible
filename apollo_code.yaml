
################################### Prereqs: ###################################

- name: place APOLLO ssh key
  copy:
    src: /home/alex/code/apollo_ansible/keys/id_rsa_apollo
    dest: /home/alex/.ssh/id_rsa_apollo
    owner: alex
    group: alex
    mode: 0600
  become: yes
  become_user: alex

- name: add bitbucket RSA key
  known_hosts:
    name: bitbucket.org
    key: "bitbucket.org,18.205.93.1 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw=="
  become: yes
  become_user: alex

################################ REDCap API lib ################################

- include_tasks: py_clone_install.yaml
  vars:
    repo_name: redcapi
    repo_url: git@bitbucket.org:atpage/redcapi.git
    key_file: /home/alex/.ssh/id_rsa_apollo

############################### GENEActiv stuff ################################

- include_tasks: py_clone_install.yaml
  vars:
    repo_name: actigraph
    repo_url: git@bitbucket.org:atpage/actigraph.git
    key_file: /home/alex/.ssh/id_rsa_apollo

- include_tasks: py_clone_install.yaml
  vars:
    repo_name: geneactiv
    repo_url: git@bitbucket.org:atpage/geneactiv.git
    key_file: /home/alex/.ssh/id_rsa_apollo

- name: compile geneactiv page parser
  command: make lib
  args:
    chdir: /home/alex/code/geneactiv/page_parser
    creates: /home/alex/code/geneactiv/page_parser/libgeneactivpage.so
  become: yes
  become_user: alex

- name: install geneactiv page parser
  command: make install
  args:
    chdir: /home/alex/code/geneactiv/page_parser
    creates: /usr/local/lib/libgeneactivpage.so
  become: yes

# TODO: install python prereqs like progressbar, matplotlib

################################## APOLLO DB ###################################

- name: install sqlalchemy
  pip:
    name: sqlalchemy
    executable: pip3
  become: yes
# TODO: that should be done automatically as a prereq of apollo_db
# ('install_requires ...' in setup.py)
# See: https://github.com/pypa/pip/issues/4780

- include_tasks: py_clone_install.yaml
  vars:
    repo_name: apollo_db
    repo_url: git@bitbucket.org:atpage/apollo_db.git
    key_file: /home/alex/.ssh/id_rsa_apollo

- name: copy REDCap token
  copy:
    src: /home/alex/code/apollo_ansible/secrets/redcap_secrets.py
    dest: /home/alex/code/apollo_db/loaders/redcap_secrets.py  # TODO: dev/test vs. prod
    owner: alex
    group: alex
    mode: 0640
  become: yes
  become_user: alex

# TODO: apollo_db/secrets.py.  note: different file for dev/test/prod because
# they point to different database servers.

############################## CIED report parser ##############################

- name: install PDF utils
  package:
    name: poppler-utils
    state: present
  become: yes

- include_tasks: py_clone_install.yaml
  vars:
    repo_name: medtronic_pdf_parser
    repo_url: git@bitbucket.org:atpage/medtronic_pdf.git
    key_file: /home/alex/.ssh/id_rsa_apollo

############################## QOL survey manager ##############################

- name: copy Chrome RPM to server
  copy:
    src: /home/alex/code/apollo_ansible/bin/google-chrome-stable_current_x86_64.rpm
    dest: /tmp/google-chrome-stable_current_x86_64.rpm
    mode: 0644
    force: no

- name: install Chrome
  yum:
    name: /tmp/google-chrome-stable_current_x86_64.rpm
    state: present
  become: yes

- name: copy selenium chrome driver to server
  copy:
    src: /home/alex/code/apollo_ansible/bin/chromedriver
    dest: /usr/local/bin/chromedriver
    mode: 0755
    #force: yes
  become: yes

# TODO: ensure chrome and webdriver versions are compatible (i.e. don't let
# someone update chrome and break the webdriver).  at least make yum ignore Chrome.

- name: pip install selenium
  pip:
    name: selenium
    executable: pip3
  become: yes

- name: download REDCap QOL selenium code
  git:
    repo: git@bitbucket.org:atpage/redcap_qol_hacks.git
    dest: /home/alex/code/redcap_qol_hacks
    key_file: /home/alex/.ssh/id_rsa_apollo
  become: yes
  become_user: alex

- name: copy REDCap token
  copy:
    src: "{{ '/home/alex/code/apollo_ansible/secrets/redcap_secrets.py' if qol_mode == 'prod' else
             '/home/alex/code/apollo_ansible/secrets/redcap_secrets_test.py' }}"
    dest: /home/alex/code/redcap_qol_hacks/redcap_secrets.py
    owner: alex
    group: alex
    mode: 0640
  become: yes
  become_user: alex

- name: copy QOL script settings file
  copy:
    content: "{{ 'PROJECT_NAME = \"APOLLO-AF\"' if qol_mode == 'prod' else
                 'PROJECT_NAME = \"APOLLO-AF (testing)\"' }}"
    dest: /home/alex/code/redcap_qol_hacks/proj_settings.py
    owner: alex
    group: alex
    mode: 0640
  become: yes
  become_user: alex

- name: copy my URMC creds for selenium to use
  copy:
    src: /home/alex/code/apollo_ansible/secrets/urmc_creds.py
    dest: /home/alex/code/redcap_qol_hacks/secrets.py
    owner: alex
    group: alex
    mode: 0640
  become: yes
  become_user: alex

- name: install Xvfb
  package:
    name:
      - "{{ 'xorg-x11-server-Xvfb' if ansible_os_family == 'RedHat' else 'xvfb' }}"
    state: present
  become: yes

- name: send surveys daily
  cron:
    name: daily QOL surveys
    user: alex
    job: "xvfb-run /home/alex/code/redcap_qol_hacks/send_redcap_surveys.py -d"
    minute: '0'
    hour: '16'
    disabled: no
  become: yes
  become_user: alex
- name: send surveys weekly
  cron:
    name: weekly QOL surveys
    user: alex
    job: "xvfb-run /home/alex/code/redcap_qol_hacks/send_redcap_surveys.py -r"
    minute: '5'
    hour: '16'
    disabled: no
  become: yes
  become_user: alex
# TODO?: don't always enable on test (because then Alex keeps getting emails)

################################################################################
