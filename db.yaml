
#################### First part: create database and users #####################

- name: pip install psycopg2
  pip:
    name: psycopg2
    executable: "{{ item }}"
  with_items:
    - pip2
    - pip3
  become: yes

- name: create APOLLO postgres user
  postgresql_user:
    name: APOLLO
    password: "{{ lookup('file', 'secrets/apollo_pg_password.txt') }}"
    encrypted: yes
    no_password_changes: yes  # TODO: only on RDS?
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"

- name: create grafana postgres user
  postgresql_user:
    name: grafana
    password: "{{ lookup('file', 'secrets/grafana_pg_password.txt') }}"
    encrypted: yes
    no_password_changes: yes  # TODO: only on RDS?
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"

- name: create APOLLO database
  postgresql_db:
    name: "APOLLO-{{ db_mode }}"
    # TODO?: restore some saved state e.g. for testing
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"

- name: give APOLLO user full access to APOLLO database
  postgresql_privs:
    type: database
    database: "APOLLO-{{ db_mode }}"
    privs: ALL
    objs: "APOLLO-{{ db_mode }}"
    roles: APOLLO
    grant_option: no
    state: present
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"

- name: give grafana user read-only access to APOLLO database
  postgresql_privs:
    type: table
    database: "APOLLO-{{ db_mode }}"
    privs: SELECT
    objs: ALL_IN_SCHEMA
    roles: grafana
    grant_option: no
    state: present
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"
  # TODO?: need to refresh as schema changes

- name: give grafana user TEMP privs on APOLLO database
  postgresql_privs:
    type: database
    database: "APOLLO-{{ db_mode }}"
    privs: TEMP
    objs: "APOLLO-{{ db_mode }}"
    roles: grafana
    grant_option: no
    state: present
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"
  # TODO: verify this is working

- name: revoke public privs to APOLLO database
  postgresql_privs:
    type: database
    database: "APOLLO-{{ db_mode }}"
    privs: ALL
    objs: "APOLLO-{{ db_mode }}"
    role: PUBLIC
    state: absent
    login_host: "{{ login_host }}"
    login_user: "{{ login_user }}"
    login_password: "{{ login_password }}"
    ssl_mode: "{{ ssl_mode }}"
# TODO: revoke apollodevdb privs as well?  or just remove from template0/1 at
# the start?

########################## Second part: create schema ##########################

# TODO: (safe) initialization of db
# maybe import e.g. 1 month of subject1+2 data for test DB

########################## Last part: set up backups ###########################

# TODO: backups (dumps) down to Z: or something

################################################################################
